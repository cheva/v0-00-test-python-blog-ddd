From e6d54e9825a4eac64d4177df779818a58a066438 Mon Sep 17 00:00:00 2001
From: Miguel Grinberg <miguel.grinberg@gmail.com>
Date: Wed, 1 Nov 2017 13:03:19 -0700
Subject: [PATCH] Chapter 19: Deployment on Docker Containers (v0.19)

---
 Dockerfile       | 16 ++++++++++++++++
 boot.sh          | 11 +++++++++++
 requirements.txt |  4 ----
 3 files changed, 27 insertions(+), 4 deletions(-)
 create mode 100644 Dockerfile
 create mode 100755 boot.sh

diff --git a/Dockerfile b/Dockerfile
new file mode 100644
index 00000000..972b18b1
--- /dev/null
+++ b/Dockerfile
@@ -0,0 +1,16 @@
+FROM python:slim
+
+COPY requirements.txt requirements.txt
+RUN pip install -r requirements.txt
+RUN pip install gunicorn pymysql cryptography
+
+COPY app app
+COPY migrations migrations
+COPY microblog.py config.py boot.sh ./
+RUN chmod a+x boot.sh
+
+ENV FLASK_APP microblog.py
+RUN flask translate compile
+
+EXPOSE 5000
+ENTRYPOINT ["./boot.sh"]
diff --git a/boot.sh b/boot.sh
new file mode 100755
index 00000000..2f0992d2
--- /dev/null
+++ b/boot.sh
@@ -0,0 +1,11 @@
+#!/bin/bash
+# this script is used to boot a Docker container
+while true; do
+    flask db upgrade
+    if [[ "$?" == "0" ]]; then
+        break
+    fi
+    echo Deploy command failed, retrying in 5 secs...
+    sleep 5
+done
+exec gunicorn -b :5000 --access-logfile - --error-logfile - microblog:app
diff --git a/requirements.txt b/requirements.txt
index 3ebea535..748314dd 100644
--- a/requirements.txt
+++ b/requirements.txt
@@ -38,7 +38,3 @@ typing_extensions==4.8.0
 urllib3==2.1.0
 Werkzeug==3.0.1
 WTForms==3.1.1
-
-# requirements for Heroku
-psycopg2-binary==2.9.9
-gunicorn==21.2.0
