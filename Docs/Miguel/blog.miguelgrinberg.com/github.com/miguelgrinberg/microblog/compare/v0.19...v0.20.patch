From fe051336d7e2fa2b821a6c6d9d137cdc4414a511 Mon Sep 17 00:00:00 2001
From: Miguel Grinberg <miguel.grinberg@gmail.com>
Date: Thu, 9 Nov 2017 19:20:27 -0800
Subject: [PATCH] Chapter 20: Some JavaScript Magic (v0.20)

---
 app/main/routes.py            |  8 ++++++++
 app/templates/_post.html      |  2 +-
 app/templates/base.html       | 30 ++++++++++++++++++++++++++++++
 app/templates/user_popup.html | 27 +++++++++++++++++++++++++++
 4 files changed, 66 insertions(+), 1 deletion(-)
 create mode 100644 app/templates/user_popup.html

diff --git a/app/main/routes.py b/app/main/routes.py
index 0f0824c9..555b14d9 100644
--- a/app/main/routes.py
+++ b/app/main/routes.py
@@ -85,6 +85,14 @@ def user(username):
                            next_url=next_url, prev_url=prev_url, form=form)
 
 
+@bp.route('/user/<username>/popup')
+@login_required
+def user_popup(username):
+    user = db.first_or_404(sa.select(User).where(User.username == username))
+    form = EmptyForm()
+    return render_template('user_popup.html', user=user, form=form)
+
+
 @bp.route('/edit_profile', methods=['GET', 'POST'])
 @login_required
 def edit_profile():
diff --git a/app/templates/_post.html b/app/templates/_post.html
index 8c0a9cd9..2a1c697e 100644
--- a/app/templates/_post.html
+++ b/app/templates/_post.html
@@ -7,7 +7,7 @@
             </td>
             <td>
                 {% set user_link %}
-                    <a href="{{ url_for('main.user', username=post.author.username) }}">
+                    <a class="user_popup" href="{{ url_for('main.user', username=post.author.username) }}">
                         {{ post.author.username }}
                     </a>
                 {% endset %}
diff --git a/app/templates/base.html b/app/templates/base.html
index 63d0f197..b64e160d 100644
--- a/app/templates/base.html
+++ b/app/templates/base.html
@@ -87,6 +87,36 @@
         const data = await response.json();
         document.getElementById(destElem).innerText = data.text;
       }
+
+      function initialize_popovers() {
+        const popups = document.getElementsByClassName('user_popup');
+        for (let i = 0; i < popups.length; i++) {
+          const popover = new bootstrap.Popover(popups[i], {
+            content: 'Loading...',
+            trigger: 'hover focus',
+            placement: 'right',
+            html: true,
+            sanitize: false,
+            delay: {show: 500, hide: 0},
+            container: popups[i],
+            customClass: 'd-inline',
+          });
+          popups[i].addEventListener('show.bs.popover', async (ev) => {
+            if (ev.target.popupLoaded) {
+              return;
+            }
+            const response = await fetch('/user/' + ev.target.innerText.trim() + '/popup');
+            const data = await response.text();
+            const popover = bootstrap.Popover.getInstance(ev.target);
+            if (popover && data) {
+              ev.target.popupLoaded = true;
+              popover.setContent({'.popover-body': data});
+              flask_moment_render_all();
+            }
+          });
+        }
+      }
+      document.addEventListener('DOMContentLoaded', initialize_popovers);
     </script>
   </body>
 </html>
diff --git a/app/templates/user_popup.html b/app/templates/user_popup.html
new file mode 100644
index 00000000..52a386f7
--- /dev/null
+++ b/app/templates/user_popup.html
@@ -0,0 +1,27 @@
+<div>
+  <img src="{{ user.avatar(64) }}" style="margin: 5px; float: left">
+  <p><a href="{{ url_for('main.user', username=user.username) }}">{{ user.username }}</a></p>
+  {% if user.about_me %}<p>{{ user.about_me }}</p>{% endif %}
+  <div class="clearfix"></div>
+  {% if user.last_seen %}
+  <p>{{ _('Last seen on') }}: {{ moment(user.last_seen).format('lll') }}</p>
+  {% endif %}
+  <p>{{ _('%(count)d followers', count=user.followers_count()) }}, {{ _('%(count)d following', count=user.following_count()) }}</p>
+  {% if user != current_user %}
+    {% if not current_user.is_following(user) %}
+    <p>
+      <form action="{{ url_for('main.follow', username=user.username) }}" method="post">
+        {{ form.hidden_tag() }}
+        {{ form.submit(value=_('Follow'), class_='btn btn-outline-primary btn-sm') }}
+      </form>
+    </p>
+    {% else %}
+    <p>
+      <form action="{{ url_for('main.unfollow', username=user.username) }}" method="post">
+        {{ form.hidden_tag() }}
+        {{ form.submit(value=_('Unfollow'), class_='btn btn-outline-primary btn-sm') }}
+      </form>
+    </p>
+    {% endif %}
+  {% endif %}
+</div>
